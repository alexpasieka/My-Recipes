<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Recipes</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
	  const parseResponse = (xhr, content) => {
		  const obj = JSON.parse(xhr.response);

		  if (obj.message) {
			  const p = document.createElement('p');
			  p.textContent = `Message: ${obj.message}`;
			  content.appendChild(p);
		  }

		  if (obj.recipes) {
			  const recipeList = document.createElement('p');
			  const recipes = JSON.stringify(obj.recipes);
			  recipeList.textContent = recipes;
			  content.appendChild(recipeList);
		  }
	  };

	  const handleResponse = (xhr) => {
		  const content = document.querySelector('#content');

		  switch(xhr.status) {
			  case 200:
				  content.innerHTML = `<b>Success</b>`;
				  break;
			  case 201:
				  content.innerHTML = '<b>Create</b>';
				  break;
			  case 204:
				  content.innerHTML = '<b>Updated (No Content)</b>';
				  return;
			  case 400:
				  content.innerHTML = `<b>Bad Request</b>`;
				  break;
			  default:
				  content.innerHTML = `Error code not implemented by client.`;
				  break;
		  }

		  parseResponse(xhr, content);
	  };

	  const sendPost = (e, form) => {
		  const formAction = form.getAttribute('action');
		  const formMethod = form.getAttribute('method');

		  const nameField = form.querySelector('#nameField');
		  const ingredientsField = form.querySelector('#ingredientsField');
		  const instructionsField = form.querySelector('#instructionsField');

		  const xhr = new XMLHttpRequest();
		  xhr.open(formMethod, formAction);

		  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		  xhr.setRequestHeader ('Accept', 'application/json');

		  xhr.onload = () => handleResponse(xhr);

		  const formData = `name=${nameField.value}&ingredients=${ingredientsField.value}
		      &instructions=${instructionsField.value}`;

		  xhr.send(formData);

		  e.preventDefault();
		  return false;
	  };

	  const init = () => {
	  	  const recipeForm = document.querySelector('#recipeForm');
	  	  const addRecipe = (e) => sendPost(e, recipeForm);
		  recipeForm.addEventListener('submit', addRecipe);
	  };

      window.onload = init;
  </script>
</head>
<body>
  <section>
      <h1>My Recipes</h1>

      <form id="recipeForm" action="/addRecipe" method="post">
          <label>Name:</label>
          <input id="nameField">

          <label>Ingredients:</label>
          <input id="ingredientsField">

          <label>Instructions: </label>
          <input id="instructionsField">

          <input type="submit">
      </form>

      <h3>Go to /getRecipes to see all recipes.</h3>
  </section>

  <section id="content"></section>
</body>
</html>
